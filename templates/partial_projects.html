{{/* This file will contain the shared code to update the data */}}
<script>
  'use strict';

	async function fetchProjects(project) {
		try {
			const response = await fetch(`/api/projects/${project}`);
			if (!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}
			const projects = await response.json();
			return projects;
		} catch (error) {
			console.error('Error fetching projects:', error);
			location.reload(); // Full page refresh on error
		}
	}

	function renderProjects(projects) {
		const container = document.getElementById('projects-container');
		const existingCards = new Map(Array.from(container.children).map(card => [card.getAttribute('url'), card]));

		projects.forEach(project => {
			const card = existingCards.get(project.URL);
			if (card) {
				// Update existing card
				if (card.getAttribute('likes') !== project.Likes.toString()) {
					card.setAttribute('likes', project.Likes);
				}
				existingCards.delete(project.URL);
			} else {
				// Add new card
				const newCard = document.createElement('project-card');
				newCard.setAttribute('url', project.URL);
				newCard.setAttribute('title', project.Title);
				if (project.Winner) {
					newCard.setAttribute('winner', '');
				}
				newCard.setAttribute('tagline', project.Tagline);
				newCard.setAttribute('likes', project.Likes);
				newCard.setAttribute('team', JSON.stringify(project.Team));
				container.appendChild(newCard);
			}
		});

		// Remove old cards
		existingCards.forEach(card => card.remove());
	}

	window.addEventListener('load', async () => {
		// Assuming 'project' is available globally or can be extracted from the URL
		const pathParts = window.location.pathname.split('/');
		const project = pathParts[pathParts.indexOf('site') + 1];
		if (project) {
			const projects = await fetchProjects(project);
			renderProjects(projects);
			setInterval(async () => {
				const projects = await fetchProjects(project);
				renderProjects(projects);
			}, 30000);
		}
	});
</script>
<div id="projects-container"></div>
