<template id="project-card-template">
  <style>
    :host {
			display: block;
			background: #ffffff;
			border-radius: 12px;
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
			padding: 25px;
			width: calc(33% - 25px);
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		:host(:hover) {
			transform: translateY(-8px);
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
		}

		h2 {
			margin-top: 0;
			margin-bottom: 10px;
			font-size: 1.6em;
			color: #34495e;
		}

		h2 a {
			text-decoration: none;
			color: #007bff;
			transition: color 0.2s ease;
		}

		h2 a:hover {
			color: #0056b3;
		}

		.tagline {
			font-style: italic;
			color: #7f8c8d;
			margin-bottom: 15px;
			font-size: 0.95em;
		}

		.team-avatars {
			display: flex;
			align-items: center;
			flex-wrap: wrap;
			margin-top: 15px;
			margin-bottom: 15px;
		}

		.roast-tagline {
			font-style: italic;
			color: #7f8c8d;
			margin-top: 10px;
			margin-bottom: 15px;
			font-size: 0.95em;
		}

		.likes {
			font-weight: bold;
			color: #e74c3c;
			font-size: 1.1em;
			display: flex;
			align-items: center;
			justify-content: flex-end;
			margin-top: auto;
		}

		.likes::before {
			content: '‚ù§Ô∏è';
			margin-right: 5px;
		}

		.description {
			margin-bottom: 15px;
			color: #555;
			font-size: 0.9em;
			line-height: 1.5;
		}

		.tags {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 10px;
			margin-bottom: 15px;
		}

		.cp-tag {
			background-color: #e0e0e0;
			color: #333;
			padding: 5px 10px;
			border-radius: 5px;
			font-size: 0.8em;
		}
  </style>
  <h2>
    <a href="">
      <span id="title-content"></span>
    </a>
    <span class="winner"></span>
  </h2>
  <p class="tagline">
    <span id="tagline-content"></span>
  </p>
  <div class="team-avatars"></div>
  <p class="roast-tagline" id="roast-tagline-content"></p>
  <p class="description">
    <span id="description-content"></span>
  </p>
  <div class="tags"></div>
  <div class="likes">
    <span id="likes-content"></span>
  </div>
</template>
<script>
  'use strict';
	class ProjectCard extends HTMLElement {
		constructor() {
			super();
			this.attachShadow({mode: 'open'});
			const template = document.getElementById('project-card-template').content;
			this.shadowRoot.appendChild(template.cloneNode(true));
			this._isIntersecting = false; // Initialize visibility flag
		}

		static get observedAttributes() {
			return ['url', 'title', 'winner', 'tagline', 'likes', 'team', 'description', 'tags'];
		}

		connectedCallback() {
			this._render();

			const observer = new IntersectionObserver((entries, observer) => {
				entries.forEach(entry => {
					this._isIntersecting = entry.isIntersecting; // Update visibility flag
					if (entry.isIntersecting) {
						this._loadRoastTagline(); // Call when it becomes visible
					}
				});
			}, {threshold: 0.1}); // Trigger when 10% of the element is visible

			observer.observe(this);
		}

		attributeChangedCallback(name, oldValue, newValue) {
			if (oldValue !== newValue) {
				this._render();
			}
		}

		_render() {
			this.shadowRoot.querySelector('h2 a').href = this.getAttribute('url') || '';
			this.shadowRoot.querySelector('#title-content').textContent = this.getAttribute('title') || '';
			const winnerSpan = this.shadowRoot.querySelector('.winner');
			if (this.hasAttribute('winner')) {
				winnerSpan.textContent = ' üèÜ';
			} else {
				winnerSpan.textContent = '';
			}
			this.shadowRoot.querySelector('#tagline-content').textContent = this.getAttribute('tagline') || '';
			this.shadowRoot.querySelector('#likes-content').textContent = this.getAttribute('likes') || '';

			const avatarsContainer = this.shadowRoot.querySelector('.team-avatars');
			while (avatarsContainer.firstChild) {
				avatarsContainer.removeChild(avatarsContainer.firstChild);
			} // Clear existing avatars
			try {
				const team = JSON.parse(this.getAttribute('team') || '[]');
				team.forEach(member => {
					const teamMember = document.createElement('team-member');
					teamMember.setAttribute('avatar-url', member.AvatarURL);
					teamMember.setAttribute('member-name', member.Name);
					teamMember.setAttribute('member-url', member.URL);
					avatarsContainer.appendChild(teamMember);
				});
			} catch (e) {
				console.error('Error parsing team attribute:', e);
			}

			// Do not show the description for now because it is too long.
			// this.shadowRoot.querySelector('#description-content').textContent = this.getAttribute('description') || '';

			const tagsContainer = this.shadowRoot.querySelector('.tags');
			while (tagsContainer.firstChild) {
				tagsContainer.removeChild(tagsContainer.firstChild);
			} // Clear existing tags
			try {
				const tags = JSON.parse(this.getAttribute('tags') || '[]');
				tags.forEach(tag => {
					const tagSpan = document.createElement('span');
					tagSpan.textContent = tag;
					tagSpan.classList.add('cp-tag');
					tagsContainer.appendChild(tagSpan);
				});
			} catch (e) {
				console.error('Error parsing tags attribute:', e);
			}

			// If _render() is called and the element is currently visible, call _loadRoastTagline()
			if (this._isIntersecting) {
				this._loadRoastTagline();
			}
		}

		async _loadRoastTagline() {
			const eventID = '{{.EventID}}';
			const projectID = this.getAttribute('project-id');
			const elem = this.shadowRoot.querySelector('#roast-tagline-content');
			if (elem.textContent || !this.getAttribute('description')) {
				// Do not update the roast once created or if the description is not loaded yet.
				return false;
			}
			elem.textContent = 'Loading roast tagline...';
			try {
				const response = await fetch('/api/roast', {
					method: 'POST',
					headers: {'Content-Type': 'application/json', },
					body: JSON.stringify({'event_id': eventID, 'project_id': projectID}),
				});
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const data = await response.json();
				elem.textContent = data.content;
			} catch (error) {
				console.error('Error fetching roast tagline:', error);
				elem.textContent = 'Error loading roast tagline.';
			}
			return true;
		}
	}

	customElements.define('project-card', ProjectCard);
</script>
{{template "team-member.html" .}}
